# syntax=docker/dockerfile:1.4
# This will be set by the GitHub action to the folder containing this component.
ARG FOLDER=/app

FROM node:24.13.0
ARG FOLDER=/app

# Install system dependencies and setup user permissions in one layer
RUN apt-get update && apt-get install -y \
    git \
    curl \
    ca-certificates \
    unzip \
    sudo && \
    rm -rf /var/lib/apt/lists/* && \
    echo "node ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/node && \
    chmod 0440 /etc/sudoers.d/node

# Enable corepack for pnpm
RUN corepack enable

WORKDIR /lib/openclaw

# Clone and build OpenClaw - always fetch latest from main branch
ARG OPENCLAW_VERSION=main
RUN git clone --depth 1 --branch ${OPENCLAW_VERSION} https://github.com/openclaw/openclaw.git . && \
    echo "Building OpenClaw from branch: ${OPENCLAW_VERSION}" && \
    git rev-parse HEAD > /lib/openclaw/openclaw-commit.txt

# Install dependencies and build in one layer with cache optimization
RUN --mount=type=cache,target=/root/.pnpm-store \
    pnpm install --frozen-lockfile && \
    OPENCLAW_A2UI_SKIP_MISSING=1 pnpm build && \
    npm_config_script_shell=bash pnpm ui:install && \
    npm_config_script_shell=bash pnpm ui:build && \
    rm -rf .git node_modules/.cache

# Global launcher so the process shows as "openclaw"
RUN install -m 0755 /dev/null /usr/local/bin/openclaw && \
    cat > /usr/local/bin/openclaw <<'EOF' && \
    chmod 0755 /usr/local/bin/openclaw
#!/usr/bin/env bash
set -euo pipefail

# Forward all args to the CLI, and set a nicer process name/title.
exec -a openclaw node --title=openclaw /lib/openclaw/dist/index.js "$@"
EOF

# Create app user (node already exists in base image)
#RUN mkdir -p /home/node/.openclaw /home/node/.openclaw/workspace \
#    && chown -R node:node /home/node /app \
#    && chmod -R 755 /home/node/.openclaw

COPY . /app
WORKDIR ${FOLDER}

ENV NODE_ENV=development

USER 1000:1000

EXPOSE 3000
ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

CMD ["npm", "run", "dev"]
