ARG FOLDER=/app
ARG OPENCLAW_VERSION=main

######## OPENCLAW BUILDER ########
FROM node:22-bookworm-slim AS openclaw-builder
ARG OPENCLAW_VERSION

RUN apt-get update && apt-get install -y --no-install-recommends \
    bash \
    ca-certificates \
    curl \
    git \
    unzip && \
    rm -rf /var/lib/apt/lists/*

RUN curl -fsSL https://bun.sh/install | bash
ENV PATH="/root/.bun/bin:${PATH}"

RUN corepack enable

WORKDIR /lib/openclaw

RUN git clone --depth 1 --branch ${OPENCLAW_VERSION} https://github.com/openclaw/openclaw.git . && \
    echo "Building OpenClaw from branch: ${OPENCLAW_VERSION}" && \
    git rev-parse HEAD > /lib/openclaw/openclaw-commit.txt && \
    pnpm install --frozen-lockfile && \
    OPENCLAW_A2UI_SKIP_MISSING=1 pnpm build && \
    npm_config_script_shell=bash pnpm ui:install && \
    npm_config_script_shell=bash pnpm ui:build && \
    CI=true pnpm prune --prod && \
    rm -rf .git node_modules/.cache

######## APP DEPS ########
FROM node:22-bookworm-slim AS app-deps
ARG FOLDER

RUN apt-get update && apt-get install -y --no-install-recommends \
    g++ \
    make \
    python3 && \
    rm -rf /var/lib/apt/lists/*

WORKDIR ${FOLDER}
COPY package*.json ./
COPY web/package*.json ./web/

RUN npm ci --include=dev && npm cache clean --force


######## RUNNER ########
FROM node:22-bookworm-slim AS runner
ARG FOLDER

WORKDIR /lib/openclaw
COPY --from=openclaw-builder /lib/openclaw /lib/openclaw

RUN install -m 0755 /dev/null /usr/local/bin/openclaw && \
    cat > /usr/local/bin/openclaw <<'EOF2' && \
    chmod 0755 /usr/local/bin/openclaw
#!/bin/sh
set -eu

exec node --title=openclaw /lib/openclaw/dist/index.js "$@"
EOF2

WORKDIR ${FOLDER}
COPY . .
COPY --from=app-deps ${FOLDER}/node_modules ${FOLDER}/node_modules
COPY --from=app-deps ${FOLDER}/web/node_modules ${FOLDER}/web/node_modules

ENV NODE_ENV=development

USER 1000:1000

EXPOSE 3000
ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

CMD ["npm", "run", "dev"]
